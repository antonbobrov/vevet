"use strict";(self.webpackChunkvevet=self.webpackChunkvevet||[]).push([[617],{"./src/components/ProgressPreloader/stories/index.stories.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{Default:()=>Default,__namedExportsOrder:()=>__namedExportsOrder,default:()=>index_stories});var react=__webpack_require__("./node_modules/react/index.js"),selectAll=__webpack_require__("./node_modules/vevet-dom/dist/es/selectAll.js"),p_cancelable=__webpack_require__("./node_modules/@anton.bobrov/p-cancelable/index.js"),AnimationFrame=__webpack_require__("./src/components/AnimationFrame/index.ts"),Preloader=__webpack_require__("./src/components/Preloader/index.ts"),Timeline=__webpack_require__("./src/components/Timeline/index.ts"),clamp=__webpack_require__("./src/utils/math/clamp.ts"),lerp=__webpack_require__("./src/utils/math/lerp.ts");function preloadCustomElement(data,instance){return new Promise((resolve=>{const{targetProgress}=data,loadProgress=function getLoadProgress({element,targetProgress}){if(void 0!==element.isComplete)return"boolean"==typeof element.isComplete&&element.isComplete?targetProgress:"number"==typeof element.isComplete?element.isComplete:0;if(void 0!==element.isLoaded){if("boolean"==typeof element.isLoaded&&element.isLoaded)return targetProgress;if("number"==typeof element.isLoaded)return element.isLoaded}const isLoadedAttr=element.getAttribute("data-is-loaded");if(null!==isLoadedAttr&&""!==isLoadedAttr&&"false"!==isLoadedAttr){const isLoadedAttrNum=parseFloat(isLoadedAttr);return Number.isNaN(isLoadedAttrNum)?targetProgress:isLoadedAttrNum}return 0}(data);loadProgress>=targetProgress?resolve():setTimeout((()=>{instance.isDestroyed||preloadCustomElement(data,instance).then((()=>resolve())).catch((()=>{}))}),50)}))}class ProgressPreloader extends Preloader.p{_getDefaultProps(){return{...super._getDefaultProps(),resourcesQuantity:0,canPreloadImages:!0,canPreloadVideos:!1,preloadCustomSelector:".js-preload",preloadIgnoreClassName:"js-preload-ignore",lerp:.1,forceEnd:500}}get images(){return this._images}get videos(){return this._videos}get customResources(){return this._customResources}get resourcesQuantity(){return this._resourcesQuantity+this.props.resourcesQuantity+this.images.length+this.videos.length+this.customResources.length+1}get loadedResourcesQuantity(){return(0,clamp.u)(this._loadedResourcesQuantity,[0,this.resourcesQuantity])}get loadProgress(){return this.loadedResourcesQuantity/this.resourcesQuantity}get progress(){return this._progress}set progress(val){this._progress=val,this._handleProgressChange()}constructor(initialProps,canInit=!0){super(initialProps,!1),this._images=[],this._videos=[],this._customResources=[],this._resourcesQuantity=0,this._loadedResourcesQuantity=0,this._progress=0,canInit&&this.init()}_init(){this._getResources(),super._init()}_setEvents(){super._setEvents();const{lerp:lerpProp}=this.props;"number"==typeof lerpProp&&(this._animationFrame=new AnimationFrame.$,this._animationFrame.addCallback("frame",(()=>{this.progress=(0,lerp.t)(this.progress,this.loadProgress,lerpProp)})),this._animationFrame.play()),this.app.onPageLoad().then((()=>this._handleLoadedResource({isSuccess:!0}))).catch((()=>{})),this._preloadResources()}_getResources(){const{canPreloadImages,canPreloadVideos,preloadCustomSelector,preloadIgnoreClassName}=this.props;if(canPreloadImages){(0,selectAll.t)("img").forEach((image=>{image.classList.contains(preloadIgnoreClassName)||this._images.push(image)}))}if(canPreloadVideos){(0,selectAll.t)("video").forEach((video=>{video.classList.contains(preloadIgnoreClassName)||this._videos.push(video)}))}preloadCustomSelector&&Array.from((0,selectAll.t)(preloadCustomSelector)).forEach((element=>{if(element.classList.contains(preloadIgnoreClassName))return;let loadCount=parseInt(element.getAttribute("data-load-count")||"1",10);loadCount=Number.isNaN(loadCount)?1:(0,clamp.u)(loadCount,[1,1/0]);for(let index=1;index<=loadCount;index+=1){const targetProgress=index/loadCount;this._customResources.push({element,targetProgress})}}))}_onLoaded(){return new p_cancelable.Z((resolve=>{let isCallbackDone=!1;this.callbacks.add("progress",(({progress})=>{progress>=1&&!isCallbackDone&&(isCallbackDone=!0,resolve())}),{isProtected:!0,name:this.name})}))}_preloadResources(){this.images.forEach((image=>function preloadImage(imageProp,action){if(imageProp.complete)return void action(!0);const image=new Image;image.addEventListener("load",(()=>action(!0))),image.addEventListener("error",(()=>action(!1))),image.crossOrigin="anonymous",image.src=imageProp.currentSrc||imageProp.src}(image,(isSuccess=>this._handleLoadedResource({element:image,isSuccess}))))),this.videos.forEach((video=>function preloadVideo(video,action){video.readyState>0?action(!0):"none"!==video.preload?(video.addEventListener("error",(()=>action(!1))),video.addEventListener("loadedmetadata",(()=>action(!0)))):action(!1)}(video,(isSuccess=>this._handleLoadedResource({element:video,isSuccess}))))),this._customResources.forEach((data=>{preloadCustomElement(data,this).then((()=>this._handleLoadedResource({element:data.element,isSuccess:!0}))).catch((()=>{}))}))}_handleLoadedResource({element,isSuccess}){this.loadProgress>=1||(this._loadedResourcesQuantity+=1,this.callbacks.tbt("resourceLoad",{element,atProgress:this.progress,loadProgress:this.loadProgress,isSuccess}),this._animationFrame||(this.progress=this.loadProgress))}iterateLoadedResources(quantityProp=1){const quantity=Math.abs(quantityProp);for(let index=0;index<quantity;index+=1)this._handleLoadedResource({isSuccess:!0})}iterateResourcesQuantity(quantity=1){this._resourcesQuantity+=quantity}_handleProgressChange(){if(this.callbacks.tbt("progress",{progress:this.progress,loadProgress:this.loadProgress}),this.progress>=1)this._animationFrame&&(this._animationFrame.destroy(),this._animationFrame=void 0);else if("number"==typeof this.props.forceEnd&&this.loadProgress>=1&&!this._endTimeline){this._animationFrame&&(this._animationFrame.destroy(),this._animationFrame=void 0),this._endTimeline=new Timeline.T({duration:this.props.forceEnd});const startProgress=this.progress;this._endTimeline.addCallback("progress",(data=>{const diff=1-startProgress;this.progress=startProgress+diff*data.progress})),this._endTimeline.play()}}_destroy(){super._destroy(),this._animationFrame?.destroy(),this._endTimeline?.destroy()}}var jsx_runtime=__webpack_require__("./node_modules/react/jsx-runtime.js");const Component=()=>{const containerRef=(0,react.useRef)(null),[progress,setProgress]=(0,react.useState)(0),[isTestElementInDom,setIsTestElementInDom]=(0,react.useState)(!0),[isCustomResourceLoaded,setIsCustomResourceLoaded]=(0,react.useState)(!1);return(0,react.useEffect)((()=>{const container=containerRef.current;if(!container)return;const instance=new ProgressPreloader({container,canPreloadImages:!0,canPreloadVideos:!0});instance.addCallback("progress",(({progress:progressProp})=>{setProgress(progressProp)})),instance.addCallback("resourceLoad",(data=>{console.log("resourceLoad",data)})),setIsTestElementInDom(!1);const timeout=setTimeout((()=>setIsCustomResourceLoaded(!0)),2e3);return()=>{instance?.destroy(),clearTimeout(timeout)}}),[]),(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("div",{ref:containerRef,className:"v-preloader",style:{display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:"#ccc",fontSize:40},children:(100*progress).toFixed(0).padStart(2,"0")}),(0,jsx_runtime.jsx)("img",{src:"https://picsum.photos/400/600",alt:"",crossOrigin:"anonymous"}),(0,jsx_runtime.jsx)("img",{src:"https://picsum.photos/400/601",alt:"",crossOrigin:"anonymous"}),(0,jsx_runtime.jsx)("img",{src:"https://picsum.photos/400/602",alt:"",crossOrigin:"anonymous"}),isTestElementInDom&&(0,jsx_runtime.jsx)("video",{autoPlay:!0,muted:!0,controls:!0,src:"https://www.shutterstock.com/shutterstock/videos/1080319025/preview/stock-footage-abstract-tech-earth-globalization-in-d-motion-graphic-concept-transmit-ai-networking-on-fiber.mp4"}),(0,jsx_runtime.jsx)("p",{className:"js-preload","data-is-loaded":isCustomResourceLoaded?"true":"false",children:"Custom preload"})]})};try{Component.displayName="Component",Component.__docgenInfo={description:"",displayName:"Component",props:{}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["src/components/ProgressPreloader/stories/index.tsx#Component"]={docgenInfo:Component.__docgenInfo,name:"Component",path:"src/components/ProgressPreloader/stories/index.tsx#Component"})}catch(__react_docgen_typescript_loader_error){}const index_stories={title:"Components/ProgressPreloader",component:Component},Default={};Default.parameters={...Default.parameters,docs:{...Default.parameters?.docs,source:{originalSource:"{}",...Default.parameters?.docs?.source}}};const __namedExportsOrder=["Default"]},"./src/components/AnimationFrame/index.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{$:()=>AnimationFrame});var _base_Component__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./src/base/Component/index.ts");class AnimationFrame extends _base_Component__WEBPACK_IMPORTED_MODULE_0__.w{_getDefaultProps(){return{...super._getDefaultProps(),fps:"auto",autoFpsFrames:10,isEnabled:!1}}get isPlaying(){return this._isPlaying}get computedFPS(){return this._computedFPS}get easeMultiplier(){return 60/this.computedFPS}constructor(initialProps,canInit=!0){super(initialProps,!1),this._isPlaying=!1,this._frame=null,this._frameIndex=-1,this._firstFrameTime=null,this._lastFrameTime=null,this._frameDurations=[],this._computedFPS="auto"!==this.props.fps?this.props.fps:60,canInit&&this.init()}_init(){super._init(),this.props.isEnabled&&this.play()}_onPropsMutate(){super._onPropsMutate(),this._frameIndex=-1,this._firstFrameTime=null,this._lastFrameTime=null,this.props.isEnabled?this._play():this._pause()}play(){this.isDestroyed||this.props.isEnabled||this.changeProps({isEnabled:!0})}_play(){this.isPlaying||(this._isPlaying=!0,this.callbacks.tbt("play",void 0),this.callbacks.tbt("toggle",void 0),this._frame=window.requestAnimationFrame(this._animate.bind(this)))}pause(){this.props.isEnabled&&this.changeProps({isEnabled:!1})}_pause(){this.isPlaying&&(this._frame&&(window.cancelAnimationFrame(this._frame),this._frame=null),this._isPlaying=!1,this.callbacks.tbt("pause",void 0),this.callbacks.tbt("toggle",void 0))}_animate(){if(!this._isPlaying)return;this._frame=window.requestAnimationFrame(this._animate.bind(this));const startTime=+new Date;null===this._firstFrameTime&&(this._firstFrameTime=startTime);const minFrameDuration="auto"===this.props.fps?1:1e3/this.props.fps,newFrameIndex=Math.floor((startTime-this._firstFrameTime)/minFrameDuration);newFrameIndex<=this._frameIndex||(this._frameIndex=newFrameIndex,this._computeFPS(startTime),this.callbacks.tbt("frame",void 0),this._lastFrameTime=startTime)}_computeFPS(startTime){const lastFrameDuration=startTime-(this._lastFrameTime??startTime);if(lastFrameDuration<=0||lastFrameDuration>250)return;if(this._frameDurations.push(lastFrameDuration),this._frameDurations.length<this.props.autoFpsFrames)return;const approximateFrameDuration=this._frameDurations.reduce(((prev,curr)=>prev+curr))/this._frameDurations.length,computedFPS=Math.floor(1e3/approximateFrameDuration),normalizedFPS=10*Math.round(computedFPS/10);this._computedFPS=normalizedFPS,this._frameDurations=[]}_destroy(){this.pause(),super._destroy()}}},"./src/components/Preloader/index.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{p:()=>Preloader});var vevet_dom__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/vevet-dom/dist/es/selectOne.js"),_utils_common_PCancelable__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./node_modules/@anton.bobrov/p-cancelable/index.js"),_base_Component__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./src/base/Component/index.ts"),_utils_common__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("./src/utils/common/normalizedTimeoutCallback.ts");class Preloader extends _base_Component__WEBPACK_IMPORTED_MODULE_0__.w{_getDefaultProps(){return{...super._getDefaultProps(),container:`#${this.prefix}`,hideAnimation:250}}get prefix(){return`${this.app.prefix}preloader`}get container(){return this._container}get startTime(){return this._startTime}get endTime(){return this._endTime}get totalTime(){return this.endTime-this.startTime}get isHidden(){return this._isHidden}constructor(initialProps,canInit=!0){if(super(initialProps,!1),this.props.container){const container=(0,vevet_dom__WEBPACK_IMPORTED_MODULE_1__.z)(this.props.container);container instanceof HTMLElement&&(this._container=container,this.toggleClassName(container,this.className(""),!0))}this._startTime=+new Date,this._endTime=1/0,this._isToBeHidden=!1,this._isHidden=!1,canInit&&this.init()}_init(){super._init(),this._setEvents()}_setEvents(){const loadEvent=this._onLoaded();loadEvent.then((()=>{this.isDestroyed||(this._endTime=+new Date,this._handleLoaded())})).catch((()=>{})),this.addDestroyableAction((()=>loadEvent.cancel()))}_onLoaded(){return this.app.onPageLoad()}_handleLoaded(){this.callbacks.tbt("loaded",void 0),"boolean"!=typeof this.props.hideAnimation&&this.hide()}hide(duration=("boolean"!=typeof this.props.hideAnimation?this.props.hideAnimation:250)){return this._isToBeHidden=!0,this.callbacks.tbt("hide",void 0),new _utils_common_PCancelable__WEBPACK_IMPORTED_MODULE_2__.Z((resolve=>{const container=this._container;if(!container)return this._handleHidden(),void resolve();container.style.transition=`opacity ${duration}ms, visibility ${duration}ms`,container.style.opacity="0",container.style.visibility="hidden";const timeout=(0,_utils_common__WEBPACK_IMPORTED_MODULE_3__.h)((()=>{container.style.display="none",this._handleHidden(),resolve()}),duration);this.addDestroyableAction((()=>timeout.clear()))}))}_handleHidden(){this._isHidden=!0,this.callbacks.tbt("hidden",void 0)}onHide(action){if(!this._isToBeHidden)return this.addCallback("hide",(()=>action()));action()}onHidden(action){if(!this._isHidden)return this.addCallback("hidden",(()=>action()));action()}}},"./src/components/Timeline/index.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{T:()=>Timeline});var _utils_math__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./src/utils/math/clamp.ts"),_BaseTimeline__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./src/components/BaseTimeline/index.ts");class Timeline extends _BaseTimeline__WEBPACK_IMPORTED_MODULE_0__.X{_getDefaultProps(){return{...super._getDefaultProps(),duration:1e3,shouldDestroyOnEnd:!1}}get isPlaying(){return void 0!==this._animationFrame}get isReversed(){return this._isReversed}get isPaused(){return this._isPaused}constructor(initialProps,canInit=!0){super(initialProps,!1),this._animationFrame=void 0,this._animationFrameLastTime=0,this._isReversed=!1,this._isPaused=!1,canInit&&this.init()}play(){this.isDestroyed||1===this.progress||(this._isReversed=!1,this._isPaused=!1,this.isPlaying||(this._animationFrameLastTime=+new Date,this._animate()))}reverse(){this.isDestroyed||0===this.progress||(this._isReversed=!0,this._isPaused=!1,this.isPlaying||(this._animationFrameLastTime=+new Date,this._animate()))}pause(){this.isDestroyed||(this._isPaused=!0,this._animationFrame&&window.cancelAnimationFrame(this._animationFrame),this._animationFrame=void 0)}reset(){this.isDestroyed||(this.pause(),this.progress=0)}_animate(){if(this.isPaused)return;const{isReversed}=this,currentTime=+new Date,frameDiff=Math.abs(this._animationFrameLastTime-currentTime);this._animationFrameLastTime=currentTime;const progressIterator=frameDiff/this.props.duration/(isReversed?-1:1),progressTarget=(0,_utils_math__WEBPACK_IMPORTED_MODULE_1__.u)(this.progress+progressIterator,[0,1]);if(this.progress=progressTarget,1===progressTarget&&!isReversed||0===progressTarget&&isReversed)return this._isReversed=!1,this._isPaused=!1,void(this._animationFrame=void 0);this._animationFrame=window.requestAnimationFrame(this._animate.bind(this))}_handleProgressUpdate(){super._handleProgressUpdate(),0!==this.progress?1===this.progress&&(this.callbacks.tbt("end",void 0),this.props.shouldDestroyOnEnd&&this.destroy()):this.callbacks.tbt("start",void 0)}_destroy(){this.pause(),super._destroy()}}},"./src/utils/math/lerp.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{function lerp(current,target,ease,approximationLeft=.001){const value=current*(1-ease)+target*ease;return Math.abs(target-value)<=approximationLeft?target:value}__webpack_require__.d(__webpack_exports__,{t:()=>lerp})},"./node_modules/vevet-dom/dist/es/isElement.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{function isElement(el){return el instanceof HTMLElement||el instanceof Element}__webpack_require__.d(__webpack_exports__,{k:()=>isElement})},"./node_modules/vevet-dom/dist/es/isWindow.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{function isWindow(el){return el instanceof Window}__webpack_require__.d(__webpack_exports__,{F:()=>isWindow})},"./node_modules/vevet-dom/dist/es/selectAll.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{t:()=>selectAll});var _isElement__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/vevet-dom/dist/es/isElement.js"),_selectOne__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/vevet-dom/dist/es/selectOne.js");function selectAll(selector,parent){if(selector instanceof NodeList)return selector;if((0,_isElement__WEBPACK_IMPORTED_MODULE_0__.k)(selector))return[selector];if(Array.isArray(selector))return selector;if(void 0!==parent){const parenEl=(0,_selectOne__WEBPACK_IMPORTED_MODULE_1__.z)(parent);if(parenEl)return parenEl.querySelectorAll(selector)}return document.querySelectorAll(selector)}},"./node_modules/vevet-dom/dist/es/selectOne.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{z:()=>selectOne});var _isElement__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/vevet-dom/dist/es/isElement.js"),_isWindow__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/vevet-dom/dist/es/isWindow.js");function selectOne(selector,parent){if((0,_isWindow__WEBPACK_IMPORTED_MODULE_0__.F)(selector))return selector;if((0,_isElement__WEBPACK_IMPORTED_MODULE_1__.k)(selector))return selector;if(void 0!==parent){const parenEl=selectOne(parent);if(parenEl)return parenEl.querySelector(selector)}return document.querySelector(selector)}}}]);